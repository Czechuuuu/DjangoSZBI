{% extends 'base.html' %}

{% block title %}Dziennik zdarzeń - SZBI{% endblock %}

{% block content %}
<h2>Dziennik zdarzeń</h2>

<p>Historia operacji wykonywanych w systemie.</p>

<!-- Filtry -->
<details>
    <summary>Filtry</summary>
    <form method="get">
        <p>
            <label for="category">Kategoria:</label>
            <select name="category" id="category">
                <option value="">-- Wszystkie --</option>
                {% for value, label in categories %}
                <option value="{{ value }}" {% if current_filters.category == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            
            <label for="action">Akcja:</label>
            <select name="action" id="action">
                <option value="">-- Wszystkie --</option>
                {% for value, label in actions %}
                <option value="{{ value }}" {% if current_filters.action == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            
            <label for="user">Użytkownik:</label>
            <select name="user" id="user">
                <option value="">-- Wszyscy --</option>
                {% for u in users %}
                <option value="{{ u.id }}" {% if current_filters.user == u.id|stringformat:"i" %}selected{% endif %}>{{ u.username }}</option>
                {% endfor %}
            </select>
        </p>
        <p>
            <label for="date_from">Data od:</label>
            <input type="date" name="date_from" id="date_from" value="{{ current_filters.date_from|default:'' }}">
            
            <label for="date_to">Data do:</label>
            <input type="date" name="date_to" id="date_to" value="{{ current_filters.date_to|default:'' }}">
            
            <label for="search">Szukaj:</label>
            <input type="text" name="search" id="search" value="{{ current_filters.search|default:'' }}" placeholder="Wpisz tekst...">
        </p>
        <p>
            <button type="submit">Filtruj</button>
            <a href="{% url 'core:activity_log_list' %}">Wyczyść filtry</a>
        </p>
    </form>
</details>

<!-- Statystyki -->
<p>
    <strong>Znaleziono:</strong> {{ page_obj.paginator.count }} zdarzeń
    {% if page_obj.paginator.num_pages > 1 %}
    | Strona {{ page_obj.number }} z {{ page_obj.paginator.num_pages }}
    {% endif %}
</p>

<!-- Tabela zdarzeń -->
{% if logs %}
<table border="1" cellpadding="8" cellspacing="0">
    <thead>
        <tr>
            <th>Data i czas</th>
            <th>Użytkownik</th>
            <th>Akcja</th>
            <th>Kategoria</th>
            <th>Obiekt</th>
            <th>Opis</th>
        </tr>
    </thead>
    <tbody>
        {% for log in logs %}
        <tr>
            <td>{{ log.created_at|date:"Y-m-d H:i:s" }}</td>
            <td>
                {% if log.user %}
                    {{ log.user.username }}
                {% else %}
                    <em>System</em>
                {% endif %}
            </td>
            <td>{{ log.get_action_display }}</td>
            <td>{{ log.get_category_display }}</td>
            <td>
                <strong>{{ log.object_repr }}</strong>
                <br><small>{{ log.object_type }}</small>
            </td>
            <td>{{ log.description|truncatewords:15 }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Paginacja -->
{% if page_obj.paginator.num_pages > 1 %}
<p>
    {% if page_obj.has_previous %}
        <a href="?page=1{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Pierwsza</a>
        <a href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Poprzednia</a>
    {% endif %}
    
    Strona {{ page_obj.number }} z {{ page_obj.paginator.num_pages }}
    
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Następna</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Ostatnia</a>
    {% endif %}
</p>
{% endif %}

{% else %}
<p><em>Brak zdarzeń spełniających podane kryteria.</em></p>
{% endif %}

<hr>

<p>
    <a href="{% url 'core:dashboard' %}">← Powrót do panelu głównego</a>
</p>

{% endblock %}
