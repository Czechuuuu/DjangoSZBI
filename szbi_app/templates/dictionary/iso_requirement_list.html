{% extends 'base.html' %}

{% block title %}Wymagania ISO - SZBI{% endblock %}

{% block content %}
<h2>Lista wymagań ISO 27001</h2>

<!-- Przyciski akcji -->
<p>
    <a href="{% url 'dictionary:iso_tree' %}">← Drzewo ISO</a>
    | <a href="{% url 'dictionary:iso_requirement_create' %}">+ Dodaj wymaganie</a>
</p>

<!-- Statystyki -->
<p>
    <strong>Statystyki:</strong>
    Razem: <strong>{{ stats.total }}</strong> |
    Stosujemy: <strong style="color:green;">{{ stats.applied }}</strong> |
    Nie stosujemy: <strong style="color:red;">{{ stats.not_applied }}</strong> |
    Częściowo: <strong style="color:orange;">{{ stats.partial }}</strong> |
    Nie dotyczy: <strong style="color:gray;">{{ stats.not_applicable }}</strong>
</p>

<!-- Filtry -->
<form method="get">
    <label for="search">Szukaj:</label>
    <input type="text" id="search" name="search" value="{{ search }}" placeholder="ID, nazwa, opis...">
    
    <label for="status">Status:</label>
    <select id="status" name="status">
        <option value="">-- Wszystkie --</option>
        {% for value, label in status_choices %}
        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    
    <label for="domain">Domena:</label>
    <select id="domain" name="domain">
        <option value="">-- Wszystkie --</option>
        {% for d in domains %}
        <option value="{{ d.pk }}" {% if domain_filter == d.pk|stringformat:"d" %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
    </select>
    
    <button type="submit">Filtruj</button>
    <a href="{% url 'dictionary:iso_requirement_list' %}">Wyczyść</a>
</form>

<hr>

<!-- Tabela wymagań -->
{% if requirements %}
<table border="1" cellpadding="8" cellspacing="0">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nazwa wymagania</th>
            <th>Domena / Cel</th>
            <th>Czy stosujemy?</th>
            <th>Sposób realizacji</th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>
        {% for req in requirements %}
        <tr>
            <td><strong>{{ req.iso_id }}</strong></td>
            <td>
                <a href="{% url 'dictionary:iso_requirement_detail' req.pk %}">{{ req.name }}</a>
            </td>
            <td>
                {% if req.objective %}
                    <small>{{ req.objective.domain.code }} → {{ req.objective.code }}</small>
                {% else %}
                    <em style="color:#999;">—</em>
                {% endif %}
            </td>
            <td>
                {% if req.is_applied == 'yes' %}
                    <span style="color:green;">✓ Tak</span>
                {% elif req.is_applied == 'no' %}
                    <span style="color:red;">✗ Nie</span>
                {% elif req.is_applied == 'partial' %}
                    <span style="color:orange;">◐ Częściowo</span>
                {% else %}
                    <span style="color:gray;">N/D</span>
                {% endif %}
            </td>
            <td>
                {% if req.implementation_method %}
                    {{ req.implementation_method|truncatewords:20 }}
                {% else %}
                    <em style="color:#999;">—</em>
                {% endif %}
            </td>
            <td>
                <a href="{% url 'dictionary:iso_requirement_detail' req.pk %}">Szczegóły</a> |
                <a href="{% url 'dictionary:iso_requirement_update' req.pk %}">Edytuj</a> |
                <a href="{% url 'dictionary:iso_requirement_delete' req.pk %}">Usuń</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Paginacja -->
{% if requirements.has_other_pages %}
<p>
    {% if requirements.has_previous %}
        <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">« Pierwsza</a>
        <a href="?page={{ requirements.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">‹ Poprzednia</a>
    {% endif %}
    
    Strona {{ requirements.number }} z {{ requirements.paginator.num_pages }}
    
    {% if requirements.has_next %}
        <a href="?page={{ requirements.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">Następna ›</a>
        <a href="?page={{ requirements.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">Ostatnia »</a>
    {% endif %}
</p>
{% endif %}

{% else %}
<p><em>Brak wymagań spełniających kryteria. <a href="{% url 'dictionary:iso_requirement_create' %}">Dodaj pierwsze wymaganie</a>.</em></p>
{% endif %}

{% endblock %}
