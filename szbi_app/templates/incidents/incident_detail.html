{% extends "base.html" %}

{% block title %}Incydent #{{ incident.pk }} - SZBI{% endblock %}

{% block content %}
<h2>Incydent #{{ incident.pk }}: {{ incident.title }}</h2>

<p>
    <a href="{% url 'incidents:list' %}">‚Üê Powr√≥t do listy</a> |
    <a href="{% url 'incidents:my_list' %}">Moje zg≈Çoszenia</a> |
    <a href="{% url 'incidents:delete' incident.pk %}" style="color: red;">Usu≈Ñ</a>
</p>

<!-- STATUS WORKFLOW -->
<div style="background: #f0f0f0; padding: 10px; margin-bottom: 20px;">
    <strong>Status:</strong> {{ incident.get_status_display }}
    
    {% if incident.get_next_status %}
    <form method="post" action="{% url 'incidents:advance_status' incident.pk %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit">Przejd≈∫ do: 
            {% if incident.status == 'reported' %}Analiza
            {% elif incident.status == 'analysis' %}Reakcja
            {% elif incident.status == 'response' %}Dzia≈Çanie
            {% elif incident.status == 'action' %}Zako≈Ñczenie
            {% endif %}
        </button>
    </form>
    {% endif %}
    
    <br>
    <small>
        Workflow: 
        <span {% if incident.status == 'reported' %}style="font-weight: bold;"{% endif %}>Zg≈Çoszony</span> ‚Üí 
        <span {% if incident.status == 'analysis' %}style="font-weight: bold;"{% endif %}>Analiza</span> ‚Üí 
        <span {% if incident.status == 'response' %}style="font-weight: bold;"{% endif %}>Reakcja</span> ‚Üí 
        <span {% if incident.status == 'action' %}style="font-weight: bold;"{% endif %}>Dzia≈Çanie</span> ‚Üí 
        <span {% if incident.status == 'closed' %}style="font-weight: bold;"{% endif %}>Zako≈Ñczony</span>
    </small>
</div>

<!-- DANE ZG≈ÅOSZENIA -->
<h3>Zg≈Çoszenie</h3>
<table border="1" cellspacing="0" cellpadding="5">
    <tr>
        <th>Temat</th>
        <td>{{ incident.title }}</td>
    </tr>
    <tr>
        <th>Opis</th>
        <td>{{ incident.description|linebreaks }}</td>
    </tr>
    <tr>
        <th>Data wystƒÖpienia</th>
        <td>{{ incident.occurred_at }}</td>
    </tr>
    <tr>
        <th>Okoliczno≈õci</th>
        <td>{{ incident.circumstances|linebreaks }}</td>
    </tr>
    <tr>
        <th>Dotkniƒôte aktywa</th>
        <td>
            {% for asset in incident.affected_assets.all %}
                <a href="{% url 'assets:detail' asset.pk %}">{{ asset.designation }}</a>{% if not forloop.last %}, {% endif %}
            {% empty %}
                -
            {% endfor %}
        </td>
    </tr>
    <tr>
        <th>Zg≈ÇaszajƒÖcy</th>
        <td>{{ incident.reporter.username }}</td>
    </tr>
    <tr>
        <th>Data zg≈Çoszenia</th>
        <td>{{ incident.created_at }}</td>
    </tr>
</table>

<!-- ANALIZA -->
<h3>Analiza</h3>
{% if incident.status != 'reported' or user.is_staff %}
<form method="post" action="{% url 'incidents:update_analysis' incident.pk %}">
    {% csrf_token %}
    <table border="1" cellspacing="0" cellpadding="5">
        <tr>
            <th>Powa≈ºny incydent</th>
            <td>
                {{ analysis_form.is_serious }}
                {% if incident.is_serious %}<span style="color: red;">‚ö† TAK</span>{% endif %}
            </td>
        </tr>
        <tr>
            <th>Dotyczy danych osobowych</th>
            <td>
                {{ analysis_form.involves_personal_data }}
                {% if incident.involves_personal_data %}<span style="color: orange;">üîí TAK</span>{% endif %}
            </td>
        </tr>
        <tr>
            <th>Klasyfikacja</th>
            <td>{{ analysis_form.severity }}</td>
        </tr>
        <tr>
            <th>Kategoria</th>
            <td>{{ analysis_form.category }}</td>
        </tr>
        <tr>
            <th>Przypisany do</th>
            <td>{{ analysis_form.assigned_to }}</td>
        </tr>
        <tr>
            <th>Notatki z analizy</th>
            <td>{{ analysis_form.analysis_notes }}</td>
        </tr>
    </table>
    <p><button type="submit">Zapisz analizƒô</button></p>
</form>
{% else %}
<p><em>Analiza dostƒôpna po zmianie statusu.</em></p>
{% endif %}

<!-- REAKCJA -->
<h3>Reakcja</h3>
{% if incident.status in 'response,action,closed' or user.is_staff %}
<form method="post" action="{% url 'incidents:update_response' incident.pk %}">
    {% csrf_token %}
    <table border="1" cellspacing="0" cellpadding="5">
        <tr>
            <th>Podjƒôte dzia≈Çania</th>
            <td>{{ response_form.response_actions }}</td>
        </tr>
        <tr>
            <th>Notatki</th>
            <td>{{ response_form.response_notes }}</td>
        </tr>
    </table>
    <p><button type="submit">Zapisz reakcjƒô</button></p>
</form>
{% else %}
<p><em>Reakcja dostƒôpna w fazie "Reakcja".</em></p>
{% endif %}

<!-- DZIA≈ÅANIE -->
<h3>Dzia≈Çanie po incydencie</h3>
{% if incident.status in 'action,closed' or user.is_staff %}
<form method="post" action="{% url 'incidents:update_action' incident.pk %}">
    {% csrf_token %}
    <table border="1" cellspacing="0" cellpadding="5">
        <tr>
            <th>Dzia≈Çania naprawcze/zapobiegawcze</th>
            <td>{{ action_form.post_incident_actions }}</td>
        </tr>
    </table>
    <p><button type="submit">Zapisz dzia≈Çania</button></p>
</form>
{% else %}
<p><em>Dzia≈Çania dostƒôpne w fazie "Dzia≈Çanie".</em></p>
{% endif %}

<!-- ZAKO≈ÉCZENIE -->
<h3>Zako≈Ñczenie</h3>
{% if incident.status == 'closed' %}
<table border="1" cellspacing="0" cellpadding="5">
    <tr>
        <th>Wnioski</th>
        <td>{{ incident.conclusions|default:"-"|linebreaks }}</td>
    </tr>
    <tr>
        <th>Data zamkniƒôcia</th>
        <td>{{ incident.closed_at }}</td>
    </tr>
</table>
{% elif incident.status == 'action' or user.is_staff %}
<form method="post" action="{% url 'incidents:close' incident.pk %}">
    {% csrf_token %}
    <p>
        <label>Wnioski:</label><br>
        {{ close_form.conclusions }}
    </p>
    <p><button type="submit" style="color: green;">Zamknij incydent</button></p>
</form>
{% else %}
<p><em>Zako≈Ñczenie dostƒôpne w fazie "Dzia≈Çanie".</em></p>
{% endif %}

<!-- NOTATKI -->
<h3>Notatki i komentarze</h3>
<form method="post" action="{% url 'incidents:add_note' incident.pk %}">
    {% csrf_token %}
    <p>
        {{ note_form.note_type }}
        {{ note_form.content }}
        <button type="submit">Dodaj notatkƒô</button>
    </p>
</form>

{% if notes %}
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%;">
    <thead>
        <tr>
            <th>Data</th>
            <th>Typ</th>
            <th>Autor</th>
            <th>Tre≈õƒá</th>
        </tr>
    </thead>
    <tbody>
        {% for note in notes %}
        <tr>
            <td>{{ note.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ note.get_note_type_display }}</td>
            <td>{{ note.author|default:"-" }}</td>
            <td>{{ note.content|linebreaks }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>Brak notatek.</p>
{% endif %}

<!-- HISTORIA -->
<h3>Historia zmian</h3>
{% if logs %}
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%;">
    <thead>
        <tr>
            <th>Data</th>
            <th>U≈ºytkownik</th>
            <th>Akcja</th>
            <th>Opis</th>
        </tr>
    </thead>
    <tbody>
        {% for log in logs %}
        <tr>
            <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
            <td>{{ log.user|default:"-" }}</td>
            <td>{{ log.get_action_display }}</td>
            <td>{{ log.description }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>Brak wpis√≥w w historii.</p>
{% endif %}

{% endblock %}
